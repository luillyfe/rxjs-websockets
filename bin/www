#!/usr/bin/env node
const app = require("../app");
const http = require("http").Server(app);
const https = require('https');
const WebSocket = require("ws");
const wss = new WebSocket.Server({ server: http });

if (process.env.NODE_ENV !== 'production') {
    require('dotenv').load();
}

const dataSourceUrl = (topic = "Google", page = 1) => "https://newsapi.org/v2/everything?" +
    "q="+ topic +"&" +
    "from=2018-10-13&" +
    "sortBy=popularity&" +
    "page="+ page +"&" +
    "apiKey="+ process.env.API_KEY +"";

const port = process.env.PORT || 3200;


http.listen(port, () => {
    console.log(`Server started and listening on ${port} port`);
});


wss.on("connection", ws => {
    let page = 1, topic = "Microsoft";

    //send immediatly a feedback to the incoming connection
    ws.send('{"message": "Conecction successfull!", "state": "ok"}');

    // look for news every 25 seconds en send them to the client.
    setInterval(() => {
        https.get(dataSourceUrl(topic, page), response => {
            console.log(`Chunk ${page}`);
            response.on("data", chunk => {
                ws.send(chunk);
            });
            response.on("end", () => {
                ws.send("end");
            });
        }).on("error", console.log);
        page++;
    }, 25000);

    ws.on("message", message => {
        let formmatedMsg = JSON.parse(message);
        formmatedMsg = (typeof formmatedMsg === "string") ? JSON.parse(formmatedMsg) : formmatedMsg;

        if (formmatedMsg.subscribe === "chat") {
            ws.send(JSON.stringify({type: "chat", message: "we heard you!"}))
        } else {
            topic = message;
        }
    });
});
